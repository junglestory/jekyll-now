<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Openfire 에서 Open Graph 플러그인 구현</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Development & Technical Training" />
    <link rel="shortcut icon" href="http://localhost:4000/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="http://localhost:4000/openfire-plugin-opengraph" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="IT Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Openfire 에서 Open Graph 플러그인 구현" />
    <meta property="og:description" content="Development & Technical Training" />
    <meta property="og:url" content="http://localhost:4000/openfire-plugin-opengraph" />
    <meta property="og:image" content="http://localhost:4000/assets/images/blog-cover.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Openfire 에서 Open Graph 플러그인 구현" />
    <meta name="twitter:description" content="Development & Technical Training" />
    <meta name="twitter:url" content="http://localhost:4000/" />
    <meta name="twitter:image" content="http://localhost:4000/assets/images/blog-cover.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="IT Blog" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="666" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "IT Blog",
        "logo": "http://localhost:4000/assets/images/blog-icon.png"
    },
    "url": "http://localhost:4000/openfire-plugin-opengraph",
    "image": {
        "@type": "ImageObject",
        "url": "http://localhost:4000/assets/images/blog-cover.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:4000/openfire-plugin-opengraph"
    },
    "description": "Development & Technical Training"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Openfire 에서 Open Graph 플러그인 구현" href="/feed.xml" />


</head>
<body class="home-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="http://localhost:4000/"><img src="/assets/images/blog-icon.png" alt="IT Blog" /></a>
            
        
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  no-image">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="20 April 2018">20 April 2018</time>
                    
                </section>
                <h1 class="post-full-title">Openfire 에서 Open Graph 플러그인 구현</h1>
            </header>

            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>페이스북이나 카카오톡에서 URL 링크을 보내면 해당 URL 페이지의 미리보기(제목, 내용, 이미지… 등) 기능을 제공한다.
Openfire에서는 아직 URL 미리보기 기능이 없기에 플러그인으로 구현하는 방법을 올려본다.</p>

<h2 id="opengraph-플러그인의-기능-구성">Opengraph 플러그인의 기능 구성</h2>

<ul>
  <li>패킷을 가로채서 메시지 여부 판단</li>
  <li>URL 메시지 여부 판단</li>
  <li>Open Graph 태그 파싱</li>
  <li>Open Graph 태그가 없는 경우 본문에서 태그 추출</li>
  <li>파싱한 태그를 패킷에 Append 해서 브로드캐스팅</li>
</ul>

<h2 id="opengraph-플러그인-개발">Opengraph 플러그인 개발</h2>
<ol>
  <li>
    <p>Openfire 소스를 <strong><a href="https://www.igniterealtime.org/downloads/source.jsp">다운로드</a></strong> 받는다.</p>
  </li>
  <li>
    <p>Eclipse에 Openfire 소스를 Import 한다.</p>
  </li>
  <li>
    <p>Opengraph 프로젝트를 생성한다.
 openfire/src/plugins 경로 밑에 opengraph 폴더를 생성한다. 그리고, opengraph 폴더 아래에 src/java/com/mydomain/openfire/opengraph 폴더를 생성하고, plugin.xml 과 pom.xml 파일을 생성한다.</p>

    <p>plugin.xml 에는 플러그인의 메인 클래스와 플러그인 정보를 설정한다.</p>
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&lt;</span><span class="p">?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="p">?</span><span class="o">&gt;</span>
 <span class="o">&lt;</span><span class="n">plugin</span><span class="o">&gt;</span>
     <span class="o">&lt;!--</span> <span class="no">Main</span> <span class="n">plugin</span> <span class="n">calss</span> <span class="o">--&gt;</span>
     <span class="o">&lt;</span><span class="k">class</span><span class="o">&gt;</span><span class="n">com</span><span class="p">.</span><span class="nf">mydomain</span><span class="p">.</span><span class="nf">openfire</span><span class="p">.</span><span class="nf">opengraph</span><span class="p">.</span><span class="nf">plugin</span><span class="o">.</span><span class="no">OpenGraphPlugin</span><span class="o">&lt;</span><span class="sr">/class&gt;

     &lt;!-- Plugin meta-data --&gt;
     &lt;name&gt;Open Graph Parser&lt;/n</span><span class="n">ame</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">description</span><span class="o">&gt;</span><span class="no">Parses</span> <span class="n">to</span> <span class="no">Open</span> <span class="no">Graph</span> <span class="n">tags</span><span class="o">&lt;</span><span class="sr">/description&gt;
     &lt;author&gt;mycompany&lt;/</span><span class="n">author</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;</span><span class="sr">/version&gt;
     &lt;date&gt;03/</span><span class="mi">20</span><span class="o">/</span><span class="mi">2018</span><span class="o">&lt;</span><span class="sr">/date&gt;
 &lt;/</span><span class="n">plugin</span><span class="o">&gt;</span>
</code></pre></div>    </div>

    <p>pom.xml 에는 플러그인, 개발자, 라이브러리 그리고 빌드 정보를 설정한다.</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
 	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
 	&lt;parent&gt;
     	&lt;artifactId&gt;plugins&lt;/artifactId&gt;
     	&lt;groupId&gt;org.igniterealtime.openfire&lt;/groupId&gt;
     	&lt;version&gt;4.2.0&lt;/version&gt;
 	&lt;/parent&gt;
 	&lt;groupId&gt;org.igniterealtime.openfire.plugins&lt;/groupId&gt;
 	&lt;artifactId&gt;openGraph&lt;/artifactId&gt;
 	&lt;version&gt;1.0.0&lt;/version&gt;
 	&lt;name&gt;Open Graph Plugin&lt;/name&gt;
 	&lt;description&gt;Parses to Open Graph tags&lt;/description&gt;

 	&lt;developers&gt;
     	&lt;developer&gt;
         	&lt;id&gt;develpoer&lt;/id&gt;
         	&lt;name&gt;develpoer&lt;/name&gt;
         	&lt;email&gt;developer@mydomain.com&lt;/email&gt;
         	&lt;organization&gt;myorganization&lt;/organization&gt;
         	&lt;organizationUrl&gt;https://www.mydomain.com&lt;/organizationUrl&gt;
     	&lt;/developer&gt;
 	&lt;/developers&gt;

     &lt;dependencies&gt;  
     	&lt;dependency&gt;
       	&lt;groupId&gt;org.jsoup&lt;/groupId&gt;
       	&lt;artifactId&gt;jsoup&lt;/artifactId&gt;
       	&lt;version&gt;1.10.2&lt;/version&gt;
     	&lt;/dependency&gt;
   	&lt;/dependencies&gt;
	  
 	&lt;build&gt;
     	&lt;sourceDirectory&gt;src/java&lt;/sourceDirectory&gt;
     	&lt;plugins&gt;
         	&lt;plugin&gt;
             	&lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
         	&lt;/plugin&gt;
     	&lt;/plugins&gt;
 	&lt;/build&gt;
 &lt;/project&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>jsoup 라이브러리를 추가한다.
<a href="https://jsoup.org/download">jsoup</a> 라이브러리를 다운로드 받아서, src/java/com/mydomain/openfire/opengraph 폴더에  lib 폴더를 생성 후 다운로드 받은 jsoup 라이브러리를 추가한다.</p>
  </li>
  <li>
    <p>Build Path에 Opengraph Plugin 소스 폴더를 추가한다.
 Eclipse에서 Properties &gt; Java Build Path &gt; Source &gt; Add Folder 버튼을 클릭해서 opengraph &gt; src &gt; java 폴더를 선택한다. 그리고, “OK” 버튼을 클릭해서  Opengraph Plugin 소스 폴더를 Build Path에 추가한다.</p>
  </li>
  <li>
    <p>Plugin 인터페이스를 구현한다.
 src/java/com/mydomain/openfire/opengraph 디렉토리에 OpenGraphPlugin.java 을 생성하고 아래 소스를 입력한다.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> import org.jivesoftware.openfire.container.Plugin;
 import org.jivesoftware.openfire.container.PluginManager;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import java.io.File;

 public class OpenGraphPlugin implements Plugin  {
     private static final Logger Log = LoggerFactory.getLogger(OpenGraphPlugin.class);
        
 	public OpenGraphPlugin() {
 	}
    
 	// 플러그인 초기화
 	public void initializePlugin(PluginManager manager, File pluginDirectory) {
    		Log.info("Open graph parser plugin initialize ...");
 	}
    
 	// 플러그인 종료
 	public void destroyPlugin() {
    		Log.info("Open graph parser plugin destory ...");
 	}
 }
</code></pre></div>    </div>
  </li>
  <li>패킷 가로채기 기능을 추가한다.
 implements 에 PacketInterceptor를 추가한다. 그리고, 생성자에 Instance를 추가하고, initializePlugins에는 메시지 Interceptor를 등록을 추가하고, destoryPlugin에는 등록된 Interceptor를 제거를 추가한다. 메시지 패킷을 확인하기 위해 interceptPacket과 isValidTargetPacket 을 추가한다.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> import org.jivesoftware.openfire.container.Plugin;
 import org.jivesoftware.openfire.container.PluginManager;
 import org.jivesoftware.openfire.interceptor.InterceptorManager;
 import org.jivesoftware.openfire.interceptor.PacketInterceptor;
 import org.jivesoftware.openfire.interceptor.PacketRejectedException;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import java.io.File;
 import org.xmpp.packet.Packet;
 import org.xmpp.packet.Message;
 import org.jivesoftware.openfire.session.Session;

 public class OpenGraphPlugin implements Plugin, PacketInterceptor  {
     private static final Logger Log = LoggerFactory.getLogger(OpenGraphPlugin.class);
     private InterceptorManager interceptorManager; 
    
     public OpenGraphPlugin() {
         interceptorManager = InterceptorManager.getInstance();
     }
   
     public void initializePlugin(PluginManager manager, File pluginDirectory) {
			Log.info("Open graph parser plugin initialize ...");
   		
			// Register a message interceptor manager
			interceptorManager.addInterceptor(this);       
     }

     public void destroyPlugin() {
			Log.info("Open graph parser plugin destory ...");
   		
			// Unregister a message interceptor manager
			interceptorManager.removeInterceptor(this);
     }
	
     @Override
     public void interceptPacket(Packet packet, Session session, boolean incoming, boolean processed)
             throws PacketRejectedException {
 		if(isValidTargetPacket(packet,incoming,processed)) {
     		Packet original = packet;               
                                   
     		if(original instanceof Message) {
         		Message receivedMessage = (Message)original;                           
         		String url = receivedMessage.getBody();
        		}      
			}
     }
	
     private boolean isValidTargetPacket(Packet packet, boolean incoming, boolean processed) {
     	return  !processed &amp;&amp; incoming &amp;&amp; packet instanceof Message;
     }
 }
</code></pre></div>    </div>
  </li>
  <li>
    <p>URL 여부를 판단한다.
 메시지가 URL인지 확인을 위해 isUrl 메소드를 추가하고, interceptPacket 메소드에 url 확인 코드를 추가한다.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @Override
 public void interceptPacket(Packet packet, Session session, boolean incoming, boolean processed)
         throws PacketRejectedException {

     if(isValidTargetPacket(packet,incoming,processed)) {
         Packet original = packet;			
						
         if(original instanceof Message) {
             Message receivedMessage = (Message)original;
				
             String url = receivedMessage.getBody();

             if (isUrl(url)) {
             	if (url.indexOf("http") &lt; 0 &amp;&amp; url.indexOf("https") &lt; 0) {
             		url = "http://" + url;
             	}	        	
		        	
             }
         }		
     }	
 }
	
 /**
  * URL 여부 체크
  * @param str
  * @return
  */
 private boolean isUrl(String str) {
     String regex = "[(http(s)?):\\/\\/(www\\.)?a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-z]{2,6}\\b([-a-zA-Z0-9@:%_\\+.~#?&amp;//=]*)";

     Pattern p = Pattern.compile(regex);
     Matcher m = p.matcher(str);

     if (m.find()) {
     	return true;
     } 
        
     return false;
 }    
</code></pre></div>    </div>
  </li>
  <li>Open graph 태그를 파싱한다.
 Open Graph 태그를 파싱 후 담을 객체를 생성한다.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> public class OpenGraphTag {
     String url;
 	String image;
 	String type;
 	String siteName;
 	String title;
 	String locale;
 	String description;
 	String createDate;

 	public String getUrl() {
     	return url;
 	}

 	public void setUrl(String url) {
     	this.url = url;
 	}

 	public String getImage() {
     	return image;
 	}

 	public void setImage(String image) {
     	this.image = image;
 	}

 	public String getType() {
     	return type;
 	}

 	public void setType(String type) {
     	this.type = type;
 	}

 	public String getSiteName() {
     	return siteName;
     }

 	public void setSiteName(String siteName) {
     	this.siteName = siteName;
 	}

 	public String getTitle() {
     	return title;
 	}

 	public void setTitle(String title) {
     	this.title = title;
 	}

 	public String getLocale() {
     	return locale;
 	}

 	public void setLocale(String locale) {
     	this.locale = locale;
 	}

 	public String getDescription() {
     	return description;
 	}

 	public void setDescription(String description) {
     	this.description = description;
 	}

 	public String getCreateDate() {
     	return createDate;
 	}

 	public void setCreateDate(String createDate) {
     	this.createDate = createDate;
 	}
 }
</code></pre></div>    </div>

    <p>현재 날짜와 캐시 기간 비교를 위해 날짜 유틸 클래스를 추가한다.</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> import java.text.ParseException;
 import java.text.SimpleDateFormat;
 import java.util.Calendar;
 import java.util.Date;

 public class DateUtils {
     private static String DATE_FORMAT = "yyyy-MM-dd HH:mm:ss";

 	/**
  	* 현재 날짜 구하기
  	* @return
  	*/
 	public static String getCurrentDate() {
     	SimpleDateFormat date = new SimpleDateFormat(DATE_FORMAT);

     	Calendar cal = Calendar.getInstance();
     	String currentDate = date.format(cal.getTime());

     	return currentDate;
 	}

 	/**
  	* 날짜 비교
  	* @param date
  	* @return
  	*/
 	public static long getDiffDate(String date)
 	{
     	long diffDays = 0L;

     	try{
         	SimpleDateFormat format = new SimpleDateFormat( DATE_FORMAT);

         	Date FirstDate = format.parse(date);
         	Date SecondDate = format.parse(getCurrentDate());

         	long diffDate = FirstDate.getTime() - SecondDate.getTime();
         	long diffDateDays = diffDate / ( 24*60*60*1000);

         	diffDays = Math.abs(diffDateDays);
     	} catch(ParseException e) {
             e.printStackTrace();
  	   }

     	return diffDays;
 	}
 }
</code></pre></div>    </div>

    <p>Open Graph 파싱을 위한 클래스를 추가한다.</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> import org.jsoup.Jsoup;
 import org.jsoup.nodes.Document;
 import org.jsoup.nodes.Element;
 import org.jsoup.select.Elements;

 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.HashMap;
 import java.util.List;
 import java.util.Map;

 public class OpenGraphParser {
     public OpenGraphParser() {
 	}

 	public OpenGraphTag parser(String url) {
 		OpenGraphTag tag = new OpenGraphTag();
         Map&lt;String, List&lt;String&gt;&gt; result = new HashMap&lt;String,List&lt;String&gt;&gt;();
 	    String[] metas = new String[]{"og:title", "og:type", "og:image", "og:url", "og:description" };

     	try {
         	Document doc = Jsoup
                 .connect(url)
                 .get();

         	Elements elements = doc.select("meta[property^=og], meta[name^=og]");

         	for (Element elm : elements) {
                 String target= elm.hasAttr("property") ? "property" : "name";

 	            if(!result.containsKey(elm.attr(target))){
     	            result.put(elm.attr(target), new ArrayList&lt;String&gt;());
         	    }

             	result.get(elm.attr(target)).add(elm.attr("content"));
         	}

             // Open Graph 태그가 없는 경우 meta 태그와 본문에서 추출
         	for(String meta : metas){
             	if (!(result.containsKey(meta) &amp;&amp; result.get(meta).size() &gt; 0)){
                 	if(meta.equals(metas[0])){
                     	result.put(metas[0]
                             , Arrays.asList(new String[]{doc.select("title").eq(0).text()}));
                 	} else if (meta.equals(metas[1])){
                     	result.put(metas[1]
                             , Arrays.asList(new String[]{"website"}));
                 	} else if (meta.equals(metas[2])){
                         result.put(metas[2]
                             , Arrays.asList(new String[]{doc.select("img").eq(0).attr("abs:src")}));
 	                } else if (meta.equals(metas[3])){
     	                result.put(metas[3]
         	                    , Arrays.asList(new String[]{doc.baseUri()}));
             	    } else if (meta.equals(metas[4])){
                 	    result.put(metas[4]
                             , Arrays.asList(new String[]{doc.select("meta[property=description], meta[name=description]").eq(0).attr("content")}));
                 	}
             	}
         	}

         	for(String meta : result.keySet()) {
             	if(meta.equals(metas[0])){
                 	tag.setTitle(result.get(meta).get(0));
             	} else if (meta.equals(metas[1])){
                     tag.setType(result.get(meta).get(0));
 	            } else if (meta.equals(metas[2])){
     	            tag.setImage(result.get(meta).get(0));
         	    } else if (meta.equals(metas[3])){
             	    tag.setUrl(result.get(meta).get(0));
             	} else if (meta.equals(metas[4])){
                 	tag.setDescription(result.get(meta).get(0));
             	}
         	}

         	tag.setCreateDate(DateUtils.getCurrentDate());
     	} catch (Exception e){
             e.printStackTrace();
         }

 	    return tag;
 	}
 }
</code></pre></div>    </div>

    <p>interceptPacket 메소드에 Open Graph 파싱 코드를 추가한다.</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @Override
 public void interceptPacket(Packet packet, Session session, boolean incoming, boolean processed)
                 throws PacketRejectedException {
 	if(isValidTargetPacket(packet,incoming,processed)) {
     	Packet original = packet;               
                                      
     	if(original instanceof Message) {
         	Message receivedMessage = (Message)original;
         	String url = receivedMessage.getBody();
            
             if (isUrl(url)) {
 	            if (url.indexOf("http") &lt; 0 &amp;&amp; url.indexOf("https") &lt; 0) {
     	            url = "http://" + url;
         	    }
                          
                 // 캐시 저장 확인
             	OpenGraphTag tag = map.get(url);
        
     			/ 캐시에 저장이 안되어 있거나 캐시 저장 기간을 초과한 경우 Open Graph 를 파싱 요청한다.
             	if (tag == null || (MAX_CACHE_DATE &lt; DateUtils.getDiffDate(tag.getCreateDate()))) {
                 	OpenGraphParser parser = new OpenGraphParser();
                 	tag = parser.parser(url);
                 	map.put(url, tag);
             	}                          
         	}
     	}            
 	}      
 }
</code></pre></div>    </div>
  </li>
  <li>
    <p>패킷에 append 해서 브로드캐스팅 한다.
가로채기한 패킷에 “<x xmlns="jabber:x:og"></x>” 엘리멘트를 추가하고, 하위에 “title, image, url, description” 추가한다.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private long MAX_CACHE_DATE = 1L;
private Map&lt;String, OpenGraphTag&gt; map = new ConcurrentHashMap&lt;String, OpenGraphTag&gt;();
    
@Override
public void interceptPacket(Packet packet, Session session, boolean incoming, boolean processed)
        throws PacketRejectedException {

    if(isValidTargetPacket(packet,incoming,processed)) {
        Packet original = packet;			
						
        if(original instanceof Message) {
            Message receivedMessage = (Message)original;
				
            String url = receivedMessage.getBody();

            if (isUrl(url)) {
            	if (url.indexOf("http") &lt; 0 &amp;&amp; url.indexOf("https") &lt; 0) {
            		url = "http://" + url;
            	}
		        	
            	OpenGraphTag tag = map.get(url);

                if (tag == null || (MAX_CACHE_DATE &lt; DateUtils.getDiffDate(tag.getCreateDate()))) {
                    OpenGraphParser parser = new OpenGraphParser();
                    tag = parser.parser(url);
                    map.put(url, tag);
                }
			        				
                // 가로채기한 패킷에 Open Graph 정보 추가
                Element sendFileElement = receivedMessage.addChildElement("x", "jabber:x:og");
                sendFileElement.addElement("title").setText(tag.getTitle());
                sendFileElement.addElement("image").setText(tag.getImage());
                sendFileElement.addElement("url").setText(tag.getUrl());
                sendFileElement.addElement("description").setText(tag.getDescription());	
            }
        }		
    }	
}
</code></pre></div>    </div>

    <p>URL에 Open Graph 정보가 있거나, Meta 정보가 있는 경우에는 클라이언트에 아래와 비슷한 패킷을 받을 것이다. 클라이언트에서는 전달받은 패킷에서 “<x xmlns="jabber:x:og"></x>” 엘리먼트를 파싱해서 UI에 사용하면 된다.</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;message xmlns="jabber:client" to="user01@localhost/56pmeoc6xd" from="room1@conference.localhost/user01" type="groupchat" id="4"&gt;
    &lt;body&gt;https://github.com&lt;/body&gt;
    &lt;x xmlns="jabber:x:event"&gt;
        &lt;composing/&gt;
    &lt;/x&gt;
    &lt;x xmlns="jabber:x:og"&gt;
        &lt;title&gt;Build software better, together&lt;/title&gt;
        &lt;image&gt;https://assets-cdn.github.com/images/modules/open_graph/github-logo.png&lt;/image&gt;
        &lt;url&gt;https://github.com&lt;/url&gt;
        &lt;description&gt;GitHub is where people build software. More than 27 million people use GitHub to discover, fork, and contribute to over 80 million projects.&lt;/description&gt;
    &lt;/x&gt;
    &lt;data xmlns="jabber:x:data" from="user@localhost" roomID="8" stamp="2018-04-20T00:51:22.939Z"/&gt;
&lt;/message&gt;
</code></pre></div>    </div>
  </li>
  <li>Ant로 빌드한다.
openfire &gt; build &gt; build.xml 파일을 마우스 오른쪽으로 클릭 후 Run As &gt; External Tools Configurations &gt; Targets 에서 openfire 와 plugins 를 체크한다. 그리고, “Run” 버튼을 클릭해서 빌드를 한다.
빌드가 성공적으로 끝나면 /Openfire/target/openfire/plugins 폴더에서 opengraphe.jar 파일을 확인 할 수 있다.</li>
</ol>

<p>전체 소스 코드는 <a href="https://github.com/junglestory/openfire-opengraph">Github repo</a> 에서 다운로드 받을 수 있다.</p>

<h2 id="open-graph-플러그인-설치">Open graph 플러그인 설치</h2>
<ol>
  <li>Admin Console의 Plugins 메뉴로 이동한다.</li>
  <li>“파일 선택” 버튼을 클릭해서 /Openfire/target/openfire/plugins/opengraph.jar 파일을 선택한다.</li>
  <li>“Upload Plugins” 버튼을 클릭한다.</li>
</ol>

<h2 id="참고자료">참고자료</h2>
<ul>
  <li><a href="http://download.igniterealtime.org/openfire/docs/latest/documentation/plugin-dev-guide.html">Openfire Plugin Developer Guide</a></li>
  <li><a href="http://trvoid.blogspot.kr/2013/05/openfire.html">[XMPP] Openfire 플러그인 개발하기</a></li>
  <li><a href="https://github.com/myriky/XMPP2APNS">XMPP2APNS</a></li>
</ul>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to IT Blog</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

                </section>
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'http://localhost:4000/';
                            this.page.identifier = 'IT Blog';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://junglestory-blog.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card  no-image">
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/tip-github">
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">로컬 프로젝트를 Github에 등록 방법</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>Github을 사용해서 프로젝트를 관리하려면, Github 저장소를 로컬에 clone 해서 사용해야 하는데, 기존 프로젝트나 CLI(Command Line Interface) 등을 이용해서 프로젝트를 생성한 경우 Github에 등록하려면 오류가 발생한다. 구글에 찾아보면 비슷한 방법들이 있는데, 최근에 Github 저장소를</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="http://localhost:4000/">
            
                <img src="/assets/images/favicon.png" alt="IT Blog icon" />
            
            <span>IT Blog</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Openfire 에서 Open Graph 플러그인 구현</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Openfire+%EC%97%90%EC%84%9C+Open+Graph+%ED%94%8C%EB%9F%AC%EA%B7%B8%EC%9D%B8+%EA%B5%AC%ED%98%84&amp;url=https://junglestory.github.ioopenfire-plugin-opengraph"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://junglestory.github.ioopenfire-plugin-opengraph"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:4000/">IT Blog</a> &copy; 2018</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                    <img class="subscribe-overlay-logo" src="/assets/images/blog-icon.png" alt="IT Blog" />
                
                <h1 class="subscribe-overlay-title">Subscribe to IT Blog</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
                <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
